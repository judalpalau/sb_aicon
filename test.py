import os
import mongoengine
import json

import google.generativeai as genai
genai.configure(api_key = os.environ.get('APIKEY_GEMINI'))


HOST = os.environ.get('MONGODB_HOST')
PORT = os.environ.get('MONGODB_PORT')
            
client = mongoengine.connect('rag', host=HOST, port = int(PORT), alias='default')

from app.models import MedicineValues as MedicineValues

embedding = genai.embed_content(
            model= "models/text-embedding-004",
            content= "Casa",
            task_type= "retrieval_document",
            title= "Embedding of single string")


pipeline = [
                {"$vectorSearch": {
                    "queryVector": embedding["embedding"],
                    "path": "embedding",
                    "numCandidates": 100,
                    "limit": 4,
                    "index": "vector_index",
                }},
                {"$project": {"embedding":0, "vector_score": { "$meta": "vectorSearchScore" }}}
            ]

query = MedicineValues.objects().aggregate(pipeline)
ans = []
for q in query:
    ans.append(q)



var vector_penalty = 1;
var full_text_penalty = 10;
db.medicine_values.aggregate([
  {
    "$vectorSearch": {
      "index": "vector_index",
      "path": "embedding",
      "queryVector": [-0.020308768, 0.041558314, -0.04482097, 0.020699747, 0.025773004, -0.00017279609, 0.043125074, 0.054340743, 0.006124883, 0.03407006, 0.028992686, 0.012220856, 0.060816135, 0.02324999, -0.0011157058, -0.09470903, 0.03141141, -0.002804203, -0.072164826, 0.002927145, -0.02176438, -0.034073412, 0.07607342, -0.036054447, -0.027898937, -0.01914807, 0.036380135, -0.005519272, -0.053349152, -0.031317834, 0.09978903, 0.068238065, 0.0056865625, -0.023426007, 0.046301674, 0.037849374, 0.024667788, 0.06723249, 0.032966666, -0.017413301, -0.056761675, 0.006678215, 0.00095862296, 0.029511586, -0.03735609, -0.022360062, -0.02573523, 0.054083582, -0.032910224, 0.021634785, 0.016988644, 0.054019287, -0.02025877, 0.01777278, -0.063503884, -0.017731631, -0.01860538, -0.028196784, 0.009142276, -0.009775112, 0.011199834, -0.021597091, -0.015405237, 0.01588953, -0.025928792, -0.01769678, -0.031665016, 0.018296529, -0.10577473, 0.02920869, 0.0049527935, 0.025614439, -0.021675428, 0.0052742655, -0.017067274, -0.050162766, 0.02829817, 0.029010495, -0.0070298864, 0.053341895, -0.035813075, 0.053718805, 0.048754875, 0.016516935, 0.002511726, -0.016228184, -0.026538981, -0.0021836045, -0.05371991, 0.002131416, 0.06666275, 0.03827399, 0.014672983, 0.032223724, 0.024950428, -0.057789803, -0.08458462, -0.07241155, 0.019180436, 0.08237231, 0.02022885, 0.0059177997, -0.020714482, -0.02998119, 0.060604848, 0.076552056, -0.048706748, -0.019454306, -0.03248653, 0.009143417, -0.001148982, -0.06017401, 0.025390262, -0.026664993, 0.041933075, -0.04210756, 0.0088233715, -0.014463959, 0.035612226, -0.018845916, -0.005399825, 0.04632661, 0.0065206112, -0.0062543186, 0.05940611, 0.007548524, 0.04513071, -0.055789318, -0.0169068, -0.0044299825, 0.10253134, -0.07491385, -0.010268927, 0.021451276, -0.023086783, -0.032507148, 0.07489892, 0.04298581, 0.027314048, 0.037574425, 0.023260955, -0.026600081, -0.11708273, 0.012438057, 0.009273835, -0.044412125, 0.046670906, 0.03596331, -0.045565672, -0.0019053861, 0.02045354, -0.024004547, -0.0036224343, -0.0023205224, -0.028800366, -0.02652482, 0.031797078, -0.019769866, 0.04117838, -0.020362161, 0.018181108, -0.06543447, 0.018852456, -0.014830268, -0.017039854, 0.03487065, 0.03954221, -0.049610943, -0.0028089455, 0.013170694, -0.0016608414, -0.011983146, 0.016515952, -0.035301927, -0.04493634, 0.015010829, -0.025605388, 0.001025237, -0.0013295996, 0.079199836, 0.11705516, 0.068138056, 0.02763677, -0.083600655, -0.008356987, 0.03231541, 0.028828636, 0.07518083, 0.072607115, 0.026649097, -0.016202567, 0.01643481, 0.028884405, 0.036752664, -0.002586873, -0.00043506842, 0.031260006, -0.0021149225, -0.075450934, -0.02875064, 0.08477912, -0.03648641, 0.013378852, -0.09332994, -0.013875726, -0.010305026, -0.036422025, -0.022502858, 0.032199882, 0.004260524, 0.018878208, -0.038013723, 0.008610838, 0.012103378, 0.015906913, -0.008609442, 0.06712801, 0.0064229704, 0.031092577, 0.06225348, -0.01761427, -0.010735417, 0.027437098, 0.03199721, 0.012553435, -0.018018821, -0.052019656, -0.025796514, 0.014556751, -0.01333287, -0.0024713322, 0.01607443, 0.018669235, 0.0006257921, 0.024849745, 0.011028318, -0.016837448, -0.05447923, -0.037051566, -0.03421437, -0.018681109, 0.019589627, -0.011519721, 0.037596714, 0.043649778, 0.09779517, 0.04652649, 0.028109316, -0.024469655, -0.05474817, -0.050420683, -0.019536274, -0.05073622, -0.06647248, -0.0040519116, -0.024659477, 0.0033852425, -0.032494348, 0.035517797, 0.0242369, -0.0016781013, -0.03608693, 0.0060070283, -0.037740737, -0.06490869, -0.050290335, -0.036252715, -0.036411714, 0.037935503, -0.05968779, 0.029446064, -0.041369144, -0.014764788, -0.024247145, 0.022497166, -0.0065683764, 0.0016021236, 0.015042205, 0.02429647, 0.014700391, 0.011931987, -0.031766467, 0.015482806, -0.0035920024, -0.037304472, -0.06049342, -0.0061179767, -0.0073031182, -0.014294001, 0.015885642, 0.04118924, 0.07119685, -0.013382039, -0.04180378, 0.059274644, 0.036174413, 0.06777326, 0.034902073, 0.020735875, -0.020911168, 0.07125618, 0.06841377, 0.02617416, 0.038579118, 0.030960264, 0.026620317, 0.06700718, -0.0847374, 0.024259917, 0.002209723, 0.0049242773, 0.02296551, -0.026564488, -0.05489846, -0.03650601, -0.0017090472, -0.14536868, -0.015601499, -0.04467857, -0.01592045, -0.020598134, 0.020059725, 0.024327017, -0.048169993, 0.055325076, -0.005863247, -0.034320354, 0.015500223, 0.023899077, -0.0076797185, 0.019095184, 0.031418934, -0.023767779, -0.046960212, 0.025265437, -0.01194455, -0.039783746, 0.04784561, 0.023527812, 0.0010247148, 0.018881224, 0.048263237, 0.02397017, 0.0070367455, 0.009085323, -0.08689417, 0.006741197, -0.004983375, 0.029962044, -0.019867085, -0.027592896, 0.06092161, -3.9597453e-05, 0.002909943, -0.021413187, -0.005311093, 0.08493854, 0.0026233837, 0.028767053, -0.021790951, -0.007576534, -0.0027327586, -7.90527e-05, -0.0125381285, -0.002411003, -0.053804297, 0.027967893, 0.009496671, -0.03575776, 0.00089463714, 0.038789343, 0.005170342, 0.0015571536, -0.0177626, -0.02441923, 0.009683444, 0.015160393, 0.014430433, 0.02727754, 0.0017340222, -0.033275783, -0.009694988, 0.0150318695, -0.014439799, -0.044562742, 0.07494556, -0.008768898, 0.0005619266, 0.026514933, -0.007902522, -0.0069951215, -0.006338251, 0.030074859, 0.029632013, 0.027589282, 0.032958753, -0.01021529, 0.05394559, 0.014360173, 0.031266402, -0.026826683, -0.022745831, 0.05145099, 0.015586387, -0.0084262, 0.00790141, 0.050870094, 0.025612991, -0.010247928, 0.026912337, -0.0027938806, 0.036771197, -0.07273, -0.026925778, -0.030636026, -0.021828568, -0.000613975, -0.010306286, -0.01966358, 0.0068215267, -0.028923534, 0.0052132076, -0.004028134, 0.020023584, 0.038643315, -0.09240809, -0.013002764, -0.012352924, 0.006740943, 0.029925572, 0.056188684, 0.0040561776, -0.023842843, 0.057063483, 0.052211355, -0.014896317, 0.020917848, -0.039244547, -0.07737149, -0.01929976, -0.006421556, -0.030229751, -0.006896795, 0.06945153, -0.01901702, 0.049069263, 0.012298731, -0.010956972, 0.004297526, -0.0020540073, -0.02654543, -0.020086015, -0.07379062, -0.013284264, -0.010658407, 0.01605751, 0.008672677, 0.0015341335, -0.02104611, 0.03433279, -0.046461884, -0.034078732, -0.0031681932, 0.009802299, 0.045558352, -0.079211466, -0.027032308, 0.077221006, 0.0032675574, -0.019478798, 0.06764156, -0.057719313, -0.011853607, 0.019198172, -0.029374026, 0.017072339, 0.04143214, 0.0035411962, -0.026815237, -0.010920024, -0.004219065, 0.040782977, -0.027277322, 0.03136219, 0.06828355, -0.017703036, -0.05588201, -0.0080811605, 0.043816328, 0.042686485, 0.01499951, 0.017199703, -0.049194906, -0.07624128, 0.03686239, 0.028064769, -0.017272055, -0.015408138, 0.0063374303, 0.05750448, 0.06043594, -0.030311264, -0.013971943, -0.048806638, -0.044822175, 0.01333954, -0.05531918, -0.04526207, 0.03331875, -0.034485757, 0.02038202, -0.012052281, -0.015831422, -0.020160647, -0.02926639, 0.00833742, -0.10443455, 0.028881302, -0.018833464, 0.024779534, 0.00052910787, 0.00086545094, 0.019694244, -0.0007795204, -0.033271547, -0.018881679, 0.059062134, -0.012139156, 0.004850423, -0.01216055, -0.060521703, 0.035799988, 0.024538197, 0.05937671, 0.012491714, 0.031024205, -0.018801676, -0.0031611018, 0.005863369, -0.04577061, -0.012756912, -0.012774884, -0.018988278, -0.02321238, 0.043789983, 0.025646105, -0.063913494, 0.0034899039, 0.0074818116, 0.050000157, 0.022219526, -0.02461702, -0.009536009, 0.024807937, -0.037549872, -0.039383452, 0.014483682, -0.010419563, -0.06028068, 0.013083603, 0.008244609, 0.008551046, -0.017820608, -0.0072672646, -0.028312609, -0.061478544, 0.0026612778, 0.054881956, -0.0063964035, -0.03179562, 0.011653822, -0.020253975, -0.0071748747, -0.030647352, 0.016243493, 0.014926778, -0.044289723, 0.025857195, 0.084913984, -0.019555764, 0.023917496, 0.00035641858, 0.041798893, 0.013352425, 0.0052028154, 0.01506889, 0.054907877, 0.013638062, 0.014434936, -0.002194665, -0.04405778, 0.014215169, -0.0043916744, -0.025877196, -0.04543202, -0.031294525, -0.023450375, -0.015260256, -0.009759053, 0.031219937, -0.0007041485, 0.00020425685, 0.038415976, 0.06431002, -0.052628685, -0.10292769, -0.024120348, -0.056418944, -0.057366636, 0.015695432, 0.005198737, 0.02484168, -0.05393262, 0.02626688, 0.016921058, 0.03072692, 0.0060089324, -0.025212536, 0.026109708, 0.0027888946, 0.0021924982, 0.03296357, -0.020155389, -0.05397677, 0.0022817412, -0.028409813, 0.012564503, 0.03606407, -0.01561206, 0.021647237, 0.0059079146, 0.030146454, 0.036327146, -0.031690672, -0.020271683, -0.028224796, -0.0056638788, -0.03697468, 0.025309747, -0.013984513, -0.008858311, -0.00868977, 0.07146909, 0.023993282, -0.045451466, 0.033889297, -0.012749719, -0.037392996, 0.008434466, 0.003236307, 0.0013462425, -0.008290246, 0.010676693, -0.030306386, -0.0065950905, 0.014005263, -0.0013548277, -0.031305574, 0.018030256, -0.06541023, -0.070811674, -0.03551861, 0.04766693, -0.016699165, -0.043333266, 0.004225601, 0.0067857085, 0.019242832, -0.0059944745, 0.003369756, 0.07128531, 0.022654753, 0.028895555, 0.051070787, -0.050414238, 0.005538446, -0.012249279, -0.02440034, -0.017167164, 0.046060704, 0.010563225, 0.008907832, -0.015871668, -0.04144789, 0.038357414, -0.000594701, 0.059803024, -0.04477041, 0.012307657, -0.025321875, -0.017759811, -0.03327101, 0.001130424, -0.0015821462, -0.02952682, 0.009270012, -0.047774933, 0.013887147, -0.050161622, -0.053647026, 0.0033409768, -0.022180386, -0.06116014, -0.032610472, 0.020143347, 0.006496458, 0.0017294681, 0.044227395, -0.04561821, -0.018206816, -0.024352303, 0.01558765, 0.017427739, 0.025217274, 0.02885177, 0.013292303, 0.008026345, 0.02997314, 0.007651755, 0.027713582, 0.0024484908, 0.0002089444, 0.019653114, 0.050711177, 0.045778293, -0.043030743, -0.076252244, 0.03586544, -0.07533279, 0.057084303, 0.025159765, 0.011314387, -0.022817247, -0.005614002, -0.00648299, -0.015432915, -0.0417554, 0.049246985, -0.02539899, 0.013169506, 0.054245614, -0.034402046, -0.06016957, 0.00027275173, -0.010579688, 0.017665386, -0.010674047, -0.023819901, -0.048866525, -0.027418984, -0.07091218, 0.029640751, 0.04726458, 0.007544175, 0.04782309, -0.015930332, 0.00300628, -0.021608759, 0.01951809, 0.032490894, -0.06163351, 0.005792696, -0.008039386, -0.0020527856, -0.05052388, -0.03739574, 0.041379444, -0.01319579],
      "numCandidates": 100,
      "limit": 20
    }
  }, {
    "$group": {
      "_id": null,
      "docs": {"$push": "$$ROOT"}
    }
  }, {
    "$unwind": {
      "path": "$docs", 
      "includeArrayIndex": "rank"
    }
  }, {
    "$addFields": {
      "vs_score": {
        "$divide": [1.0, {"$add": ["$rank", vector_penalty, 1]}]
      }
    }
  }, {
    "$project": {
      "vs_score": 1, 
      "_id": "$docs._id", 
      "title": "$docs.name"
    }
  },
  {
    "$unionWith": {
      "coll": "medicine_values",
      "pipeline": [
        {
          "$search": {
            "index": "rrf-full-text-search",
            "phrase": {
              "query": "new york",
              "path": "title"
            }
          }
        }, {
          "$limit": 20
        }, {
          "$group": {
            "_id": null,
            "docs": {"$push": "$$ROOT"}
          }
        }, {
          "$unwind": {
            "path": "$docs", 
            "includeArrayIndex": "rank"
          }
        }, {
          "$addFields": {
            "fts_score": {
              "$divide": [
                1.0,
                {"$add": ["$rank", full_text_penalty, 1]}
              ]
            }
          }
        },
        {
          "$project": {
            "fts_score": 1,
            "_id": "$docs._id",
            "title": "$docs.title"
          }
        }
      ]
    }
  },
  {
    "$group": {
      "_id": "$title",
      "vs_score": {"$max": "$vs_score"},
      "fts_score": {"$max": "$fts_score"}
    }
  },
  {
    "$project": {
      "_id": 1,
      "title": 1,
      "vs_score": {"$ifNull": ["$vs_score", 0]},
      "fts_score": {"$ifNull": ["$fts_score", 0]}
    }
  },
  {
    "$project": {
      "score": {"$add": ["$fts_score", "$vs_score"]},
      "_id": 1,
      "title": 1,
      "vs_score": 1,
      "fts_score": 1
    }
  },
  {"$sort": {"score": -1}},
  {"$limit": 10}
])